<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet" />

    <link rel="stylesheet" href="index.css" />

    <link rel="stylesheet" id="theme" href="light.css" />
    <link rel="preload" href="dark.css" as="style" />

    <title>Random Issue Picker</title>
  </head>
  <body>
    <script>
      /**
       * Sets the theme of the page. If no theme is provided, it will toggle between light and dark.
       *
       * @param {string | undefined} theme The theme to set.
       *
       * @returns {void}
       */
      function setTheme(theme) {
        /** @type {HTMLLinkElement} */
        const css = document.getElementById("theme");

        if (!theme) theme = css.href.endsWith("light.css") ? "dark.css" : "light.css";

        css.href = theme;

        localStorage.setItem("theme", theme);

        document.getElementById("themeButton").textContent = theme === "light.css" ? "ðŸ”†" : "ðŸŒ™";
      }
    </script>

    <div style="float: right">
      <button onclick="setTheme()" id="themeButton">ðŸ”†</button>
    </div>

    <script>
      let theme = localStorage.getItem("theme");

      const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)");

      if (!theme && prefersDarkScheme.matches) theme = "dark.css";

      setTheme(theme);
    </script>

    <h1>Random Issue Picker</h1>

    <p>Current open issues: <a id="issues">...</a></p>

    <script>
      /**
       * @typedef {{
       *  name: string,
       *  issues: number
       * }} RepoInfo
       */

      var repoInfo = {
        name: null,
        issues: -1,
      };

      /**
       * Parses the URL of a GitHub repository.
       *
       * @param {string} url The URL of the GitHub repository.
       * @returns {string} The name of the repository.
       */
      function parseUrl(url) {
        const name = url.match(/(?:git@|https:\/\/)github.com[:\/](.*)/);

        if (name) return name[1].replace(/\.git$/, "");
        return null;
      }

      /**
       * Fetches the number of open issues in a GitHub repository.
       *
       * @returns {Promise<number>} The number of open issues in the repository.
       */
      async function fetchIssuesCount() {
        if (repoInfo.name === null) return -1;

        try {
          const response = await fetch(`https://api.github.com/repos/${repoInfo.name}/issues?per_page=1`);

          if (!response.ok) return -1;

          if ((await response.json()).length === 0) return 0;

          const link = response.headers.get("Link");
          if (!link) return 1;

          return link.match(/page=(\d+)>; rel="last"/)[1];
        } catch {
          return -1;
        }
      }

      /**
       * Github API response for an issue.
       *
       * @typedef {{
       *   number: number,
       *   title: string,
       *   user: {
       *     login: string,
       *     avatar_url: string,
       *     html_url: string
       *   },
       *   html_url: string
       * }} Issue
       */

      /**
       * Fetches a random issue from a GitHub repository.
       *
       * @returns {Promise<Issue>} The random issue url.
       */
      async function randomIssue() {
        if (repoInfo.issues === -1) return null;

        const page = Math.floor(Math.random() * repoInfo.issues) + 1;
        const response = await fetch(`https://api.github.com/repos/${repoInfo.name}/issues?per_page=1&page=${page}`);

        const issues = await response.json();
        return issues[0];
      }
    </script>

    <script>
      async function onUrlInput() {
        repoInfo.name = parseUrl(document.querySelector("#url").value);
        repoInfo.issues = await fetchIssuesCount();
        document.querySelector("#issues").textContent = repoInfo.issues === -1 ? "..." : repoInfo.issues;
      }
    </script>

    <label for="url">Repo URL:</label>
    <input
      type="text"
      id="url"
      name="url"
      style="width: 100%; max-width: 500px"
      onkeypress="this.onchange();"
      onpaste="this.onchange();"
      oninput="this.onchange();"
      onchange="onUrlInput()" />

    <script>
      /**
       * Creates an entry in the history list for an issue.
       *
       * @param {Issue} issue The issue to create an entry for.
       *
       * @returns {void}
       */
      function makeIssueEntry(issue) {
        const history = document.getElementById("history");

        const issueEntry = document.createElement("li");
        issueEntry.innerHTML = `Issue <a href="${issue.html_url}">#${issue.number}</a>: ${issue.title}<br /><div style="margin-top: 1vh; text-align: bottom; display: flex; align-items: end">Opened by&nbsp<a href="${issue.user.html_url}" style="display: flex; align-items: end"><img class="avatar" src="${issue.user.avatar_url}" />&nbsp${issue.user.login}</a></div>`;

        history.appendChild(issueEntry);
      }

      async function openRandomIssue() {
        const issue = await randomIssue();
        if (!issue) return;

        const issues = JSON.parse(localStorage.getItem("issues"));
        if (issues) {
          issues.push(issue);
          localStorage.setItem("issues", JSON.stringify(issues));
        } else localStorage.setItem("issues", JSON.stringify([issue]));

        if (localStorage.getItem("openInNewTab") === "true") window.open(issue.html_url, "_blank");

        makeIssueEntry(issue);
      }
    </script>

    <br />

    <button style="margin-top: 2vh" onclick="openRandomIssue()">Pick random issue</button>
    <input type="checkbox" id="openInNewTab" onchange="localStorage.setItem('openInNewTab', this.checked)" />
    <label for="openInNewTab">Open in new tab</label>

    <br />

    <div id="exampleUrls">
      <p style="margin-bottom: 1vh">Example URLs:</p>
      <ul style="margin-top: 0">
        <li>https://github.com/oven-sh/bun</li>
        <li>https://github.com/tobycm/akatsuki-du-ca-bot-remastered.git</li>
        <li>git@github.com:pdt1806/discord-status-as-image.git</li>
      </ul>
    </div>

    <p style="margin-bottom: 1vh">History:</p>
    <ul style="margin-top: 0" id="history"></ul>

    <script>
      const issues = JSON.parse(localStorage.getItem("issues"));

      if (issues) issues.forEach((issue) => makeIssueEntry(issue));
    </script>
  </body>
</html>
